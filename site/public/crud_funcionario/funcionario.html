<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>empresa</title>
  <link rel="stylesheet" href="../assets/css/funcionario/funcionario.css" />
</head>

<body>
  <section>

    <div class="navBarLateral">

      <div class="user">
        <div class="fotoUser">
        </div>
        <h2 id="NomeUsuario"></h2>
      </div>
      <div class="navegarLeteral">
        <li style="display: none;" id="empresa_lateral"><a href="../crud_empresa/empresa.html">EMPRESA</a></li>
        <li> <a href="../crud_maquina/maquina.html"> MÁQUINA</a></li>
        <li id="aqui">FUNCIONÁRIO</li>
        <li><a href="../crud_usuario/usuario.html"> USUÁRIO</a></li>
      </div>
      <div class="sair" onclick="sair()"><span>Sair</span></div>
    </div>

    <div class="areaPrincipal">
      <header>
        <nav>
          <ul>
            <li id="cadFunc" style="display:none"><a onclick="cadastrarFUNC()">Cadastrar Funcionário</a></li>
            <li id="aqui2"><a style="display:block">Cadastrar Funcionário</a></li>
            <li id="altFunc" style="display: block;"><a onclick="alterarFUNC()">Alterar Funcionário</a></li>
            <li id="aqui3" style="display: none;"><a>Alterar Funcionário</a></li>
            <li id="listFunc" style="display: block;"><a onclick="listarFUNC()">Listar Funcionário</a></li>
            <li id="aqui4" style="display: none;"><a>Listar Funcionário</a></li>
            <li id="deletFunc" style="display: block;"><a onclick="deletarFUNC()">Deletar Funcionário</a></li>
            <li id="aqui5" style="display: none;"><a>Deletar Funcionário</a></li>
          </ul>
        </nav>
      </header>

      <div class="areaTitulo">

        <div id="tituloCAD" class="titulo">
          <h1>Cadastro Funcionário</h1>
        </div>

        <div id="tituloALT" class="titulo" style="display: none;">
          <h1>Buscar Funcionário</h1>
        </div>
        <div id="tituloLIST" class="titulo" style="display: none;">
          <h1>Listagem de Funcionários</h1>
        </div>
        <div id="tituloDELET" class="titulo" style="display: none;">
          <h1>Desligar Funcionário</h1>
        </div>
        <div class="menssagem" id="menssagem">

        </div>

      </div>


      <div id="cadastroFunc" class="cadastro-func" style="display:block;">
        <div class="input" id="ipt-1">
          Nome
          <input type="text" name="nome" id="cad_nome" />
        </div>
        <div class="input" id="ipt-2">
          Matricula
          <input type="text" name="matricula" id="cad_matricula" />
        </div>
        <div class="input" id="ipt-3">
          Setor
          <input type="number" name="setor" id="cad_setor" />
        </div>
        <div class="input" id="ipt-5">
          Empresa
          <input type="number" name="funcao" id="cad_empresa" />
        </div>
        <div class="input" id="ipt_gestorCAD" style="display: none;">
          Gestor
          <input type="number" name="funcao" id="cad_gestor" />
        </div>
        <button id="btn_entrar" onclick="autenticarFUNC()">Cadastrar</button>
      </div>


      <div id="alterarFunc" class="alterar-func" style="display:none;">
        <div class="input2" id="ipt-1">
          Matricula:
          <input type="text" name="nome" id="Alt_matricula" />
          <button id="btn_entrar" onclick="aparecerBuscados()">Buscar</button>
        </div>
      </div>


      <div id="alterarFunc2" class="alterar-func2" style="display:none;">
        <div class="input3" id="ipt-1">
          Nome
          <input type="text" name="nome" placeholder="Altere o CNPJ" id="alt_nome" />
        </div>
        <div class="input3" id="ipt-2">
          Matricula
          <input type="text" name="matricula" placeholder="Altere a Razão Social" id="alt_matricula" />
        </div>
        <div class="input3" id="ipt-3">
          Setor
          <input type="number" name="setor" placeholder="Altere o Responsável" id="alt_setor" />
        </div>
        <div class="input3" id="ipt-4">
          Empresa
          <input type="number" name="maquina" placeholder="Altere o numeroSerial" id="alt_empresa" />
        </div>
        <div class="input3" id="ipt_gestorALT" style="display:none;">
          Gestor
          <input type="number" name="funcao" placeholder="Altere o Telefone" id="alt_gestor" />
        </div>
        <button id="btn_entrar" onclick="alterar()">Alterar</button>
      </div>


      <div class="funcionarios" id="funcionario" style="display: none;">
        <div class="funcionarios2" id="funcionario2">

          <div id="listarFunc" class="listar-func">
            <div class="input" id="ipt-1">
              Foram encontradas:
            </div>
            <div id="funcionarios_lista">
            </div>
          </div>


          <div id="listarFunc2" class="listar-func2">
            <div class="input" id="ipt-1">
              Nome
              <input type="text" name="nome" id="list_nome" readonly />
            </div>
            <div class="input" id="ipt-2">
              Matricula
              <input type="text" name="matricula" id="list_matricula" readonly />
            </div>
            <div class="input" id="ipt-3">
              Setor
              <input type="text" name="setor" id="list_setor" readonly />
            </div>
            <div class="input" id="ipt-4">
              empresa
              <input type="text" name="maquina" id="ipt_maquina" readonly />
            </div>
            <div class="input" id="ipt-5">
              gestor
              <input type="text" name="funcao" id="ipt_funcao" readonly />
            </div>
          </div>

        </div>
      </div>


      <div id="deletarFunc" class="deletar-func" style="display:none;">
        <div id="buscarDelete" style="display:block;">
          <div class="input" id="ipt-1">
            Matricula
            <input type="text" name="nome" id="Delet_matricula" />
          </div>
          <button id="btn_entrar" onclick="aparecerDelete()">Procurar</button>
        </div>

        <div id="deletarFunc2" class="deletarFunc2" style="display:none;">
          <h3>Tem certeza que deseja excluir essa empresa ?</h3>
          <li>Nome:<span id="del_nome"></span></li>
          <li>Matricula:<span id="del_matricula"></span></li>
          <li>Setor:<span id="del_setor"></span></li>
          <li>Empresa:<span id="del_empresa"></span></li>
          <li>Gestor:<span id="del_gestor"></span></li>
          <div class="SimNao">
            <li onclick="deletar()">Sim</li>
            <li onclick="voltar()">Não</li>
          </div>
        </div>
      </div>
    </div>



  </section>
</body>

</html>
<script>
  var EmailUsuario = "";
  var NomeDousuario = "";

  EmailUsuario = sessionStorage.EMAIL_USUARIO;

  NomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;

  console.log(sessionStorage.NOME_USUARIO);
  //if (EmailUsuario && EmailUsuario.includes("analyx@")) {
  // listFunc.style.display = "block";
  // deletFunc.style.display = "block";
  // }

  if (EmailUsuario != undefined && EmailUsuario.includes("analyx@")) {
    empresa_lateral.style.display = "block";

    //cad
    ipt_gestorCAD.style.display = "block";

    //alt
    ipt_gestorALT.style.display = "block";

  } else {

    cadastroFunc.style.height = "58vh";
    alterarFunc2.style.height = "58vh";
  }

  function sair() {
    window.location = "../index.html";
    sessionStorage.clear();

  }




  function teste() {
    menssagem.style.display = "block";
    menssagem.innerHTML = "Cadastrado com sucesso!";
    setTimeout(() => {
      menssagem.style.display = "none";
    }, "4000")
  }


  function cadastrarFUNC() {
    //header
    aqui3.style.display = "none";
    aqui4.style.display = "none";
    aqui5.style.display = "none";
    cadFunc.style.display = "none";

    altFunc.style.display = "block";
    listFunc.style.display = "block";
    deletFunc.style.display = "block";

    aqui2.style.display = "block";

    //social
    alterarFunc.style.display = "none";
    listarFunc.style.display = "none";
    deletarFunc.style.display = "none";
    alterarFunc2.style.display = "none";
    funcionario.style.display = "none";


    cadastroFunc.style.display = "block";

    //titulo
    tituloCAD.style.display = "block";
    tituloALT.style.display = "none";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "none";

  }
  function alterarFUNC() {
    //header
    aqui2.style.display = "none";
    aqui4.style.display = "none";
    aqui5.style.display = "none";
    altFunc.style.display = "none";

    deletFunc.style.display = "block";
    listFunc.style.display = "block";
    cadFunc.style.display = "block";

    aqui3.style.display = "block";

    //social
    cadastroFunc.style.display = "none";
    listarFunc.style.display = "none";
    deletarFunc.style.display = "none";
    alterarFunc2.style.display = "none";
    funcionario.style.display = "none";



    alterarFunc.style.display = "block";

    //titulo
    tituloCAD.style.display = "none";
    tituloALT.style.display = "block";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "none";
  }

  function listarFUNC() {
    //header
    aqui2.style.display = "none";
    aqui3.style.display = "none";
    aqui5.style.display = "none";
    listFunc.style.display = "none";

    cadFunc.style.display = "block";
    altFunc.style.display = "block";
    deletFunc.style.display = "block";

    aqui4.style.display = "block";


    //social
    cadastroFunc.style.display = "none";
    alterarFunc.style.display = "none";
    deletarFunc.style.display = "none";
    alterarFunc2.style.display = "none";


    listarFunc.style.display = "block";
    funcionario.style.display = "block";



    //titulo
    tituloCAD.style.display = "none";
    tituloALT.style.display = "none";
    tituloLIST.style.display = "block";
    tituloDELET.style.display = "none";
  }

  function deletarFUNC() {
    //header
    aqui2.style.display = "none";
    aqui3.style.display = "none";
    aqui4.style.display = "none";
    deletFunc.style.display = "none";

    cadFunc.style.display = "block";
    altFunc.style.display = "block";
    listFunc.style.display = "block";

    aqui5.style.display = "block";

    //social
    cadastroFunc.style.display = "none";
    alterarFunc.style.display = "none";
    listarFunc.style.display = "none";
    alterarFunc2.style.display = "none";


    deletarFunc.style.display = "block";


    //titulo
    tituloCAD.style.display = "none";
    tituloALT.style.display = "none";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "block";

  }
  var ax_erro = false;


  function autenticarFUNC() {
    var matricula = cad_matricula.value;

    fetch("/funcionario/autenticarFUNC", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        matriculaServer: matricula,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO entrar()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          if (json === false) {
            alert("Já existe um funcionario com a mesmo matricula!");
            ax_erro = true;
            return;
          } else {
            ax_erro = false;
            cadastrar();
          }


        });

      } else {

        console.log("Houve um erro ao tentar realizar o cadastro!");
        ax_erro = true;
        alert("Essa empresa já está cadastrada!")
        return;

        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
      ax_erro = true;

    })
    ax_erro = true;
  }

  function cadastrar() {


    var nome = cad_nome.value;
    var matricula = cad_matricula.value;
    var setor = cad_setor.value;
    var empresa = cad_empresa.value;

    if (EmailUsuario != undefined && EmailUsuario.includes("analyx@")) {
      var gestor = cad_gestor.value;
    } else {
      var gestor = sessionStorage.GESTOR_USUARIO;

    }
    // var ax_erro = false


    if (nome == "" || matricula == "" || setor == "" || empresa == "" || gestor == "") {

      alert("Por favor, preencha todos os campos!")
      ax_erro = true;
    } else if (cad_nome.value.length <= 2) {
      alert("Nome invalido! Nome muito curto!")
      ax_erro = true;
    } else if (cad_nome.value.length >= 15) {
      alert("Nome invalido! Nome muito longo")
      ax_erro = true;
    } else if (matricula.length <= 2 && matricula.length >= 25) {
      alert("Razao social não pode ser muito curta ou muito longa")
      ax_erro = true;
    } else if (setor.length < 3 && setor.length > 25) {
      alert("Razao social não pode ser muito curta ou muito longa!")
      ax_erro = true;
    }

    if (ax_erro == false) {



      fetch("/funcionario/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          nomeServer: nome,
          matriculaServer: matricula,
          setorServer: setor,
          empresaServer: empresa,
          gestorServer: gestor,
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          alert("Cadastro realizado com sucesso!");
          setTimeout(() => {
            window.location = "funcionario.html";
          }, "2000")

        } else {
          throw ("Houve um erro ao tentar realizar o cadastro!");
        }


      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
      return false;
    }
  }

  function aparecerBuscados() {


    var matricula = Alt_matricula.value;

    console.log(matricula);

    if (matricula == "") {

      alert(`Preencha o campo matricula!`)

      return false;
    }



    console.log("FORM matricula: ", matricula);

    fetch("/funcionario/pegarFuncionario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        matriculaAltServer: matricula,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);


        if (resposta.status == 204) {
          alert("Nenhuma funcionario encontrado!")
        } else {
          resposta.json().then(json => {
            console.log(json);
            console.log(JSON.stringify(json));

            sessionStorage.ID_FUNCIONARIOCAD = json.id;
            sessionStorage.NOME_FUNCIONARIOCAD = json.nome;
            sessionStorage.MATRICULA_FUNCIONARIOCAD = json.matricula;
            sessionStorage.SETOR_FUNCIONARIOCAD = json.fkSetor;
            sessionStorage.EMPRESA_FUNCIONARIOCAD = json.fkEmpresa;
            sessionStorage.GESTOR_FUNCIONARIOCAD = json.fkGestor;
            console.log(sessionStorage.MATRICULA_FUNCIONARIOCAD);


            if (sessionStorage.MATRICULA_FUNCIONARIOCAD != null && sessionStorage.MATRICULA_FUNCIONARIOCAD != undefined) {
              alert("Funcionario encontrada!")
              alterarFunc2.style.display = "block";
              alterarFunc.style.height = "15%";
            }
            alt_nome.value = sessionStorage.NOME_FUNCIONARIOCAD;
            alt_matricula.value = sessionStorage.MATRICULA_FUNCIONARIOCAD;
            alt_setor.value = sessionStorage.SETOR_FUNCIONARIOCAD;
            alt_empresa.value = sessionStorage.EMPRESA_FUNCIONARIOCAD;
            alt_gestor.value = sessionStorage.GESTOR_FUNCIONARIOCAD;

            console.log(sessionStorage.MATRICULA_FUNCIONARIOCAD);
          });
        }

      } else {
        alert("matricula invalida!")

        console.log("Houve um erro ao tentar procurar!");

        resposta.text().then(texto => {
          console.error(texto);
          //    finalizarAguardar(texto);
        });
      }

    }).catch(function (erro) {
      alert("funcionario(a) não encontrado!")

      console.log(erro);
    })

    return false;
  }


  function alterar() {

    var nomeNovo = alt_nome.value;
    var matriculaNovo = alt_matricula.value;
    var setorNovo = alt_setor.value;
    var empresaNovo = alt_empresa.value;
    var gestorNovo = alt_gestor.value;
    var id = sessionStorage.ID_FUNCIONARIOCAD;
    var ax_erro = false;

    console.log(id);

    if (alt_nome.value == "" || alt_matricula.value == "" || alt_setor.value == "" || alt_empresa.value == ""
      || alt_gestor.value == "") {
      alert("Por favor, preencha todos os campos!")
      return false;
    } else if (alt_nome.value.length < 3) {
      alert("nome invalido!")
      return false;
    } else if (matriculaNovo.length <= 2 || matriculaNovo.length >= 25) {
      alert("matricula não pode ser muito curta ou muito longa")
      return false;
    } else if (setorNovo.length <= 0 || setorNovo.length > 10000000) {
      alert(" setor invalido! escolha um numero de setor existente!")
      return false;
    } else if (empresaNovo.length <= 0 || empresaNovo.length > 1000000) {
      alert("empresa invalida!")
      return false;
    } else if (gestorNovo.length <= 0 && gestorNovo.length > 1000000) {
      alert("Gestor invalido!")
      return false;
    } else if (alt_nome.value == sessionStorage.NOME_FUNCIONARIOCAD && alt_matricula.value == sessionStorage.MATRICULA_FUNCIONARIOCAD
      && alt_setor.value == sessionStorage.SETOR_FUNCIONARIOCAD && alt_serial.value == sessionStorage.EMPRESA_FUNCIONARIOCAD
      && alt_funcao.value == sessionStorage.GESTOR_FUNCIONARIOCAD) {
      alert("Nenhuma alteração feita!")
      return false;
    }
    else {
      // Enviando o valor da nova input
      fetch("/funcionario/alterar", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js
          nomenovoServer: nomeNovo,
          matriculanovoServer: matriculaNovo,
          setornovoServer: setorNovo,
          empresanovoServer: empresaNovo,
          gestornovoServer: gestorNovo,
          idServer: id,
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);
        if (resposta.ok) {


          menssagem.style.display = "block";
          menssagem.innerHTML = "Alteração realizada com sucesso!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")
          alt_nome.value = "";
          alt_matricula.value = "";
          alt_setor.value = "";
          alt_empresa.value = "";
          alt_gestor.value = "";
          setTimeout(() => {
            window.location = "funcionario.html";
          }, "2000")

        } else {
          throw ("Houve um erro ao tentar realizar a alteração!");
          menssagem.style.display = "block";
          menssagem.innerHTML = "Houve um erro ao realizar a alteração!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")

        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

      return false;
    }

  }

  var informacaoList = -1;
  function listFuncionarios(i) {
    informacaoList = i;
    listagemFuncionario();

  }
  var listarUmaVez = false;

  listagemFuncionario()

  function listagemFuncionario() {

    fetch("/funcionario/listar", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.MATRICULA_FUNCIONARIOLIST = json.matricula;
          console.log(json.length);

          if (listarUmaVez == false) {

            for (i = 0; i < json.length; i++) {
              var registro = json[i];
              funcionarios_lista.innerHTML += `<li onclick="listFuncionarios(${i})">${registro.matricula}</li>`;
              listarUmaVez = true;
            }
          }


          for (i = 0; i < json.length; i++) {
            var registro = json[i];
            if (informacaoList >= 0) {
              if (i == informacaoList) {
    
                list_nome.value = `${registro.nome}`;
                list_matricula.value = `${registro.matricula}`;
                list_setor.value = `${registro.fkSetor}`;
                list_empresa.value = `${registro.fkEmpresa}`;
                list_gestor.value = `${registro.fkGestor}`;
              }
            }
          }


          if (sessionStorage.MATRICULA_FUNCIONARIOLIST != null && sessionStorage.MATRICULA_FUNCIONARIOLIST != undefined) {
            // alert("Empresa encontrada!")
          } else {
            //   alert("empresa null ou undefined")
          }
        });

      } else {
        console.log("Houve um erro ao tentar encontrar empresas!");
        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }


  function aparecerDelete() {

    var matricula = Delet_matricula.value;

    console.log(matricula);

    if (matricula.value == "") {

      alert(`Preencha o campo cnpj!`)

      return false;
    }

    console.log("FORM matricula: ", matricula);

    fetch("/funcionario/pegarFuncionario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        matriculaAltServer: matricula,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          deletarFunc2.style.display = "block";
          buscarDelete.style.display = "none";

          sessionStorage.ID_FUNCIONARIODEL = json.id;
          sessionStorage.NOME_FUNCIONARIODEL = json.nome;
          sessionStorage.MATRICULA_FUNCIONARIOADEL = json.matricula;
          sessionStorage.SETOR_FUNCIONARIODEL = json.fkSetor;
          sessionStorage.EMPRESA_FUNCIONARIODEL = json.fkEmpresa;
          sessionStorage.GESTOR_FUNCIONARIODEL = json.fkGestor;

          del_nome.innerHTML = sessionStorage.NOME_FUNCIONARIODEL;
          del_matricula.innerHTML = sessionStorage.MATRICULA_FUNCIONARIOADEL;
          del_setor.innerHTML = sessionStorage.SETOR_FUNCIONARIODEL;
          del_empresa.innerHTML = sessionStorage.EMPRESA_FUNCIONARIODEL;
          del_gestor.innerHTML = sessionStorage.GESTOR_FUNCIONARIODEL;


          if (sessionStorage.MATRICULA_FUNCIONARIOADEL != null && sessionStorage.MATRICULA_FUNCIONARIOADEL != undefined) {
            alert("Empresa encontrada!")
          }

        });

      } else {
        alert("numeroSerial ou senha invalidos!")

        console.log("Houve um erro ao tentar procurar o funcionario!");

        resposta.text().then(texto => {
          console.error(texto);
          //    finalizarAguardar(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
      alert("Empresa não encontrada")
    })

    return false;
  }


  function deletar() {
    deletarFunc2.style.display = "block";
    buscarDelete.style.display = "none";

    var id = sessionStorage.ID_FUNCIONARIODEL;

    if (id == "") {

      return false;
    }


    console.log("FORM id: ", id);

    fetch("/funcionario/deletar", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idServer: id,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO DELETAR!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          alert("Empresa deletada com sucesso!")
          deletarFunc2.style.display = "none";
          buscarDelete.style.display = "block";
        });

      } else {
        alert("Ops! há um erro no sistema, já estamos tentando resolver.")

        console.log("Houve um erro ao tentar deletar!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function voltar() {
    deletarFunc2.style.display = "none";
    buscarDelete.style.display = "block";
  }
</script>