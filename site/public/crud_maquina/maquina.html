<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>empresa</title>
  <link rel="stylesheet" href="../assets/css/maquina/maquinaa.css" />
</head>

<body>
  <section>

    <div class="navBarLateral">
      <div class="user">
        <h2 id="NomeUsuario"></h2>
      </div>

      <div class="navegarLeteral">
        <li style="display:none;" id="empresa_lateral"><a href="../crud_empresa/empresa.html">EMPRESA</a></li>
        <li id="aqui">MÁQUINA</a></li>
        <li><a href="../crud_funcionario/funcionario.html">FUNCIONÁRIO</a></li>
        <li><a href="../crud_usuario/usuario.html"> USUÁRIO</a></li>
      </div>
      <div class="sair" onclick="sair()"><span>Voltar</span></div>
    </div>

    <div class="areaPrincipal">
      <header>
        <nav>
          <ul>
            <li id="altMaq" style="display: none;"><a onclick="alterarMAQ()"> Alterar Maquina</a></li>
            <li id="aqui3" style="display: block;"><a>Alterar Maquina</a></li>
            <li id="listMaq" style="display: block;"><a onclick="listarMAQ()">Listar Maquina</a></li>
            <li id="aqui4" style="display: none;"><a>Listar Maquina</a></li>
            <li id="deletMaq" style="display: block;"><a onclick="deletarMAQ()">Deletar Maquina</a></li>
            <li id="aqui5" style="display: none;"><a>Deletar Maquina</a></li>
          </ul>
        </nav>
      </header>

      <div class="areaTitulo">

        <div id="tituloALT" class="titulo" style="display: block;">
          <h1>Buscar Máquina</h1>
        </div>
        <div id="tituloLIST" class="titulo" style="display: none;">
          <h1>Listagem de Máquinas</h1>
        </div>
        <div id="tituloDELET" class="titulo" style="display: none;">
          <h1>Deletar Máquina</h1>
        </div>
        <div class="menssagem" id="menssagem">

        </div>
      </div>


      <div id="alterarMaq" class="alterar-maq" style="display:block;">
        <div class="input2" id="ipt-1">
          Host Name:
          <input type="text" name="nome" id="Alt_hostName" />
          <button id="btn_entrar" onclick="aparecerBuscados()">Buscar</button>
        </div>
      </div>







      <div id="alterarMaq2" class="alterar-maq2" style="display:none;">
        <div class="input3" id="ipt-1">
          CPU
          <input type="text" name="nome" placeholder="Altere o CPU" id="alt_cpu" />
        </div>
        <div class="input3" id="ipt-2">
          RAM
          <input type="text" name="matricula" placeholder="Altere a RAM" id="alt_ram" />
        </div>
        <div class="input3" id="ipt-3">
          DISCO
          <input type="text" name="setor" placeholder="Altere o Disco" id="alt_disco" />
        </div>
        <div class="input3" id="ipt-4">
          hostName
          <input type="text" name="maquina" placeholder="Altere o HostName" id="alt_hostName" />
        </div>
        <button id="btn_entrar" onclick="alterar()">Alterar</button>
      </div>


      <div class="maquinas" id="maquinas" style="display:none">
        <div class="maquinas2" id="maquinas2">
          <div id="listarMaq" class="listar-maq">
            <div class="input" id="ipt-1">
              Foram encontradas:
            </div>
            <div id="maquinas_lista">
            </div>
          </div>

          <div id="listarMaq2" class="listar-maq2">
            <div class="input" id="ipt-1">
              hostName
              <input type="text" name="nome" id="list_hostname" readonly />
            </div>
            <div class="input" id="ipt-2">
              DISCO
              <input type="text" name="matricula" id="list_disco" readonly />
            </div>
            <div class="input" id="ipt-3">
              Modelo CPU
              <input type="text" name="setor" id="list_cpu" readonly />
            </div>
            <div class="input" id="ipt-4">
              RAM
              <input type="text" name="maquina" id="list_ram" readonly />
            </div>
          </div>
        </div>
      </div>


      <div id="deletarMaq" class="deletar-maq" style="display:none;">
        <div id="buscarDelete" style="display:block;">
          <div class="input" id="ipt-1">
            Host name:
            <input type="text" name="nome" id="Delet_hostName" />
          </div>
          <button id="btn_entrar" onclick="aparecerDelete()">Procurar</button>
        </div>

        <div id="deletarMaq2" class="deletarMaq2" style="display:none;">
          <h3>Tem certeza que deseja excluir essa empresa ?</h3>
          <li>CPU :<span id="del_cpu"></span></li>
          <li>RAM:<span id="del_ram"></span></li>
          <li>DISCO:<span id="del_disco"></span></li>
          <li>Numero Serial da Maquina:<span id="del_hostName"></span></li>
          <div class="SimNao">
            <li onclick="deletar()">Sim</li>
            <li onclick="voltar()">Não</li>
          </div>
        </div>
      </div>
    </div>




  </section>
</body>

</html>
<script>
  var EmailUsuario = "";
  var NomeDousuario = "";

  EmailUsuario = sessionStorage.EMAIL_USUARIO;

  NomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;


  if (EmailUsuario != undefined && EmailUsuario.includes("analyx@")) {
    empresa_lateral.style.display = "block";
  }

  function sair() {
    window.location = "../dashboard/dashboard-init.html";
    sessionStorage.clear();

  }

  function alterarMAQ() {
    //header
    aqui4.style.display = "none";
    aqui5.style.display = "none";
    altMaq.style.display = "none";

    deletMaq.style.display = "block";
    listMaq.style.display = "block";

    aqui3.style.display = "block";

    //social
    listarMaq.style.display = "none";
    deletarMaq.style.display = "none";
    alterarMaq2.style.display = "none";
    maquinas.style.display = "none";


    alterarMaq.style.display = "block";

    //titulo
    tituloALT.style.display = "block";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "none";

  }

  function listarMAQ() {
    //header
    aqui3.style.display = "none";
    aqui5.style.display = "none";
    listMaq.style.display = "none";

    altMaq.style.display = "block";
    deletMaq.style.display = "block";

    aqui4.style.display = "block";


    //social
    alterarMaq.style.display = "none";
    deletarMaq.style.display = "none";
    alterarMaq2.style.display = "none";


    listarMaq.style.display = "block";
    maquinas.style.display = "block";


    //titulo
    tituloALT.style.display = "none";
    tituloLIST.style.display = "block";
    tituloDELET.style.display = "none";
  }

  function deletarMAQ() {
    //header
    aqui3.style.display = "none";
    aqui4.style.display = "none";
    deletMaq.style.display = "none";

    altMaq.style.display = "block";
    listMaq.style.display = "block";

    aqui5.style.display = "block";

    //social
    alterarMaq.style.display = "none";
    listarMaq.style.display = "none";
    alterarMaq2.style.display = "none";
    maquinas.style.display = "none";


    deletarMaq.style.display = "block";

    //titulo
    tituloALT.style.display = "none";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "block";

  }


  function aparecerDelete() {
    deletarMaq2.style.display = "block";
    buscarDelete.style.display = "none";
  }

  function aparecerBuscados() {


    var hostName = Alt_hostName.value;

    console.log(hostName);

    if (Alt_hostName.value == "") {

      alert(`Preencha o campo hostName!`)

      return false;
    }


    console.log("FORM hostName: ", hostName);

    fetch("/maquina/pegarMaquina", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        hostNameAltServer: hostName,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);


        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          if (Object.keys(json).length === 0) {
            alert("Nenhuma maquina encontrada!");
          } else {

            sessionStorage.CPU_MAQUINA = json.modeloCPU;
            sessionStorage.RAM_MAQUINA = json.total;
            sessionStorage.DISCO_MAQUINA = json.volume;
            sessionStorage.CPU_MAQUINA2 = json.fkCpu;
            sessionStorage.RAM_MAQUINA2 = json.fkRam;
            sessionStorage.DISCO_MAQUINA2 = json.fkDisco;
            sessionStorage.HOSTNAME_MAQUINA = json.hostName;

            alterarMaq2.style.display = "block";
            alterarMaq.style.height = "15%";


            alt_cpu.value = sessionStorage.CPU_MAQUINA;
            alt_ram.value = sessionStorage.RAM_MAQUINA;
            alt_disco.value = sessionStorage.DISCO_MAQUINA;
            alt_hostName.value = sessionStorage.HOSTNAME_MAQUINA;
            console.log(sessionStorage.HOSTMAQUINA_MAQUINA);
          }
        });
      } else {
        alert("Host Name invalidos!")

        console.log("Houve um erro ao tentar buscar a maquina!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      alert("maquina não encontrada!");
      console.log(erro);
    })
    return false;
  }

  function alterar() {

    var cpuNovo = alt_cpu.value;
    var ramNovo = alt_ram.value;
    var discoNovo = alt_disco.value;
    var cpuNovo2 = sessionStorage.CPU_MAQUINA2;
    var ramNovo2 = sessionStorage.RAM_MAQUINA2;
    var discoNovo2 = sessionStorage.DISCO_MAQUINA2;
    var hostNameNovo = alt_hostName.value;
    var hostNameVelho = Alt_hostName.value;
    var ax_erro = false;


    if (alt_cpu.value == "" || alt_ram.value == "" || alt_disco.value == "" || alt_hostName.value == "") {
      alert("Por favor, preencha todos os campos!")
      return false;
    } else if (alt_hostName.value.length < 4) {
      alert("hostName invalido!")
      return false;
    } else if (alt_cpu.value == sessionStorage.CPU_MAQUINA && alt_ram.value == sessionStorage.RAM_MAQUINA
      && alt_disco.value == sessionStorage.DISCO_MAQUINA && alt_hostName.value == sessionStorage.hostName_MAQUINA) {
      alert("Nenhuma alteração feita!")
      return false;
    }
    else {
      // Enviando o valor da nova input
      fetch("/maquina/alterar", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js

          cpunovoServer: cpuNovo,
          ramnovoServer: ramNovo,
          disconovoServer: discoNovo,
          cpunovo2Server: cpuNovo2,
          ramnovo2Server: ramNovo2,
          disconovo2Server: discoNovo2,
          hostNamenovoServer: hostNameNovo,
          hostNameVelhoServer: hostNameVelho
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);
        if (resposta.ok) {
          menssagem.style.display = "block";
          menssagem.innerHTML = "Alteração realizada com sucesso!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")
          alt_cpu.value = "";
          alt_ram.value = "";
          alt_disco.value = "";
          alt_hostName.value = "";
          setTimeout(() => {
            window.location = "maquina.html";
          }, "2000")

        } else {
          throw ("Houve um erro ao tentar realizar a alteração!");
          menssagem.style.display = "block";
          menssagem.innerHTML = "Houve um erro ao realizar a alteração!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")

        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

      return false;
    }

  }

  var informacaoList = -1;
  function listMaquinas(i) {
    informacaoList = i;
    listagemMaquinas();

  }
  var listarUmaVez = false;


  listagemMaquinas()

  function listagemMaquinas() {

    fetch("/maquina/listar", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          localStorage.hostName_LISTA = json.hostName;
          console.log(json.length);

          if (listarUmaVez == false) {

            for (i = 0; i < json.length; i++) {
              var registro = json[i];
              maquinas_lista.innerHTML += `<li onclick="listMaquinas(${i})">${registro.hostName}</a></li>`;
              listarUmaVez = true;
            }
          }

          for (i = 0; i < json.length; i++) {
            var registro = json[i];
            if (informacaoList >= 0) {
              if (i == informacaoList) {
                list_hostname.value = `${registro.hostName}`;
                list_cpu.value = `${registro.modeloCPU}`;
                list_disco.value = `${registro.total} GB`;
                list_ram.value = `${registro.volume} Volume`;
              }

            }

          }

          if (sessionStorage.HOSTNAME_LISTA != null && sessionStorage.HOSTNAME_LISTA != undefined) {
            // alert("Empresa encontrada!")
          } else {
            //   alert("empresa null ou undefined")
          }
        });

      } else {
        console.log("Houve um erro ao tentar encontrar as maquinas!");
        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function aparecerDelete() {

    var hostName = Delet_hostName.value;

    if (hostName == "") {

      alert(`Preencha o campo cnpj!`)

      return false;
    }

    console.log("FORM hostName: ", hostName);

    fetch("/maquina/pegarMaquina", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        hostNameAltServer: hostName,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          deletarMaq2.style.display = "block";
          buscarDelete.style.display = "none";

          sessionStorage.ID_MAQUINADEL = json.id;
          sessionStorage.CPU_MAQUINADEL = json.modeloCPU;
          sessionStorage.RAM_MAQUINADEL = json.total;
          sessionStorage.DISCO_MAQUINADEL = json.volume;
          sessionStorage.HOSTNAME_MAQUINADEL = json.hostName;

          del_cpu.innerHTML = sessionStorage.CPU_MAQUINADEL;
          del_ram.innerHTML = sessionStorage.RAM_MAQUINADEL;
          del_disco.innerHTML = sessionStorage.DISCO_MAQUINADEL;
          del_hostName.innerHTML = sessionStorage.HOSTNAME_MAQUINADEL;


          if (sessionStorage.HOSTNAME_MAQUINADEL != null && sessionStorage.HOSTNAME_MAQUINADEL != undefined) {
            console.log("validação ok")
          }

        });

      } else {
        alert("Maquina não encontrada!")

        resposta.text().then(texto => {
          console.error(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
      alert("Maquina não encontrada")
    })

    return false;
  }


  function deletar() {
    deletarMaq2.style.display = "block";
    buscarDelete.style.display = "none";

    var id = sessionStorage.ID_MAQUINADEL;

    if (id == "") {

      return false;
    }


    console.log("FORM id: ", id);

    fetch("/maquina/deletar", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idServer: id,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO DELETAR!")

      if (resposta.ok) {
        console.log(resposta);
        menssagem.style.display = "block";
        menssagem.innerHTML = "Maquina deletada com sucesso!";
        setTimeout(() => {
          menssagem.style.display = "none";
        }, "3000")
        setTimeout(() => {
          window.location = "maquina.html";
        }, "2000")
          ;

      } else {
        alert("Ops! há um erro no sistema, já estamos tentando resolver.")

        console.log("Houve um erro ao tentar deletar!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function voltar() {
    deletarMaq2.style.display = "none";
    buscarDelete.style.display = "block";
  }

</script>