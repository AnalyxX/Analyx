<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>empresa</title>
  <link rel="stylesheet" href="../assets/css/maquina/maquinaa.css" />
</head>

<body>
  <section>

    <div class="navBarLateral">

      <div class="user">
        <div class="fotoUser">
        </div>
        <h2 id="NomeUsuario">Nome Usuário</h2>
      </div>
      <div class="navegarLeteral">
        <li> <a href="../crud_empresa/empresa.html">EMPRESA</a></li>
        <li id="aqui">MÁQUINA</a></li>
        <li><a href="../crud_funcionario/cadastrarFuncionario.html">FUNCIONÁRIO</a></li>
        <li><a href="../crud_usuario/cadastro-user.html"> USUÁRIO</a></li>
      </div>
      <div class="sair" onclick="sair()"><span>Sair</span></div>
    </div>

    <div class="areaPrincipal">
      <header>
        <nav>
          <ul>
            <li id="altMaq" style="display: block;"><a onclick="alterarMAQ()"> Alterar Maquina</a></li>
            <li id="aqui3" style="display: none;"><a>Alterar Maquina</a></li>
            <li id="listMaq" style="display: block;"><a onclick="listarMAQ()">Listar Maquina</a></li>
            <li id="aqui4" style="display: none;"><a>Listar Maquina</a></li>
            <li id="deletMaq" style="display: block;"><a onclick="deletarMAQ()">Deletar Maquina</a></li>
            <li id="aqui5" style="display: none;"><a>Deletar Maquina</a></li>
          </ul>
        </nav>
      </header>

      <div class="areaTitulo">

        <div id="tituloALT" class="titulo" style="display: block;">
          <h1>Buscar Máquina</h1>
        </div>
        <div id="tituloLIST" class="titulo" style="display: none;">
          <h1>Listagem de Máquinas</h1>
        </div>
        <div id="tituloDELET" class="titulo" style="display: none;">
          <h1>Deletar Máquina</h1>
        </div>
        <div class="menssagem" id="menssagem">

        </div>
      </div>


      <div id="alterarMaq" class="alterar-maq" style="display:block;">
        <div class="input2" id="ipt-1">
          Número Serial:
          <input type="text" name="nome" id="Alt_numeroSerial" />
          <button id="btn_entrar" onclick="aparecerBuscados()">Buscar</button>
        </div>
      </div>


      <div id="alterarMaq2" class="alterar-maq2" style="display:none;">
        <div class="input3" id="ipt-1">
          CPU
          <input type="text" name="nome" placeholder="Altere o numeroSerial" id="alt_cpu" />
        </div>
        <div class="input3" id="ipt-2">
          RAM
          <input type="text" name="matricula" placeholder="Altere a Razão Social" id="alt_ram" />
        </div>
        <div class="input3" id="ipt-3">
          DISCO
          <input type="text" name="setor" placeholder="Altere o Responsável" id="alt_disco" />
        </div>
        <div class="input3" id="ipt-4">
          Número Serial
          <input type="text" name="maquina" placeholder="Altere o Email" id="alt_numeroSerial" />
        </div>
        <button id="btn_entrar" onclick="alterar()">Alterar</button>
      </div>



      <div id="listarMaq" class="listar-maq" style="display:none;">
        <div class="input" id="ipt-1">
          Foram encontradas:
        </div>
        <div id="maquinas_lista">

        </div>

      </div>
      <div id="listarMaq2" class="listar-maq" style="display:none;">
        <div class="input" id="ipt-1">
          numeroSerial
          <input type="text" name="nome" id="ipt_nome" />
          <div class="input" id="ipt-2">
            Razão social
            <input type="text" name="matricula" id="ipt_matricula" />
          </div>
          <div class="input" id="ipt-3">
            Responsavel
            <input type="text" name="setor" id="ipt_setor" />
          </div>
          <div class="input" id="ipt-4">
            E-mail
            <input type="text" name="maquina" id="ipt_maquina" />
          </div>
          <div class="input" id="ipt-5">
            Telefone
            <input type="text" name="funcao" id="ipt_funcao" />
          </div>
        </div>

      </div>

      <div id="deletarMaq" class="deletar-maq" style="display:none;">
        <div id="buscarDelete" style="display:block;">
          <div class="input" id="ipt-1">
            Numero Serial:
            <input type="text" name="nome" id="Delet_numeroSerial" />
          </div>
          <button id="btn_entrar" onclick="aparecerDelete()">Procurar</button>
        </div>

        <div id="deletarMaq2" class="deletarMaq2" style="display:none;">
          <h3>Tem certeza que deseja excluir essa empresa ?</h3>
          <li>CPU:<span id="del_cpu"></span></li>
          <li>RAM:<span id="del_ram"></span></li>
          <li>DISCO:<span id="del_disco"></span></li>
          <li>Numero Serial da Maquina:<span id="del_numeroSerial"></span></li>
          <div class="SimNao">
            <li onclick="deletar()">Sim</li>
            <li onclick="voltar()">Não</li>
          </div>
        </div>
      </div>
    </div>




  </section>
</body>

</html>
<script>
  var EmailUsuario = "";
  var NomeDousuario = "";

  EmailUsuario = sessionStorage.EMAIL_USUARIO;

  NomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;

  function sair() {
    window.location = "../index.html";
    sessionStorage.clear();

  }

  function alterarMAQ() {
    //header
    aqui4.style.display = "none";
    aqui5.style.display = "none";
    altMaq.style.display = "none";

    deletMaq.style.display = "block";
    listMaq.style.display = "block";

    aqui3.style.display = "block";

    //social
    listarMaq.style.display = "none";
    deletarMaq.style.display = "none";
    alterarMaq2.style.display = "none";


    alterarMaq.style.display = "block";

    //titulo
    tituloALT.style.display = "block";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "none";

  }

  function listarMAQ() {
    //header
    aqui3.style.display = "none";
    aqui5.style.display = "none";
    listMaq.style.display = "none";

    altMaq.style.display = "block";
    deletMaq.style.display = "block";

    aqui4.style.display = "block";


    //social
    alterarMaq.style.display = "none";
    deletarMaq.style.display = "none";
    alterarMaq2.style.display = "none";


    listarMaq.style.display = "block";

    //titulo
    tituloALT.style.display = "none";
    tituloLIST.style.display = "block";
    tituloDELET.style.display = "none";
  }

  function deletarMAQ() {
    //header
    aqui3.style.display = "none";
    aqui4.style.display = "none";
    deletMaq.style.display = "none";

    altMaq.style.display = "block";
    listMaq.style.display = "block";

    aqui5.style.display = "block";

    //social
    alterarMaq.style.display = "none";
    listarMaq.style.display = "none";
    alterarMaq2.style.display = "none";


    deletarMaq.style.display = "block";


    //titulo
    tituloALT.style.display = "none";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "block";

  }


  function aparecerDelete() {
    deletarMaq2.style.display = "block";
    buscarDelete.style.display = "none";
  }

  function aparecerBuscados() {


    var numeroSerial = Alt_numeroSerial.value;

    console.log(numeroSerial);

    if (Alt_numeroSerial.value == "") {

      alert(`Preencha o campo numeroSerial!`)

      return false;
    }


    console.log("FORM numeroSerial: ", numeroSerial);

    fetch("/maquina/pegarMaquina", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        numeroSerialAltServer: numeroSerial,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);


        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          if (Object.keys(json).length === 0) {
            alert("Nenhuma maquina encontrada!");
          } else {

            sessionStorage.CPU_MAQUINA = json.fkCpu;
            sessionStorage.RAM_MAQUINA = json.fkRam;
            sessionStorage.DISCO_MAQUINA = json.fkDisco;
            sessionStorage.NUMEROSERIAL_MAQUINA = json.numeroSerial;

            alterarMaq2.style.display = "block";
            alterarMaq.style.height = "15%";


            alt_cpu.value = sessionStorage.CPU_MAQUINA;
            alt_ram.value = sessionStorage.RAM_MAQUINA;
            alt_disco.value = sessionStorage.DISCO_MAQUINA;
            alt_numeroSerial.value = sessionStorage.NUMEROSERIAL_MAQUINA;
            console.log(sessionStorage.NUMEROSERIAL_MAQUINA);
          }
        });
      } else {
        alert("Numero Serial invalidos!")

        console.log("Houve um erro ao tentar buscar a maquina!");

        resposta.text().then(texto => {
          console.error(texto);
          //    finalizarAguardar(texto);
        });
      }

    }).catch(function (erro) {
      alert("Empresa não encontrada!");
      console.log(erro);
    })
    return false;
  }

  function alterar() {
    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var cpuNovo = alt_cpu.value;
    var ramNovo = alt_ram.value;
    var discoNovo = alt_disco.value;
    var numeroSerialNovo = alt_numeroSerial.value;
    var numeroSerialVelho = Alt_numeroSerial.value;
    var ax_erro = false;


    if (alt_cpu.value == "" || alt_ram.value == "" || alt_disco.value == "" || alt_numeroSerial.value == "") {
      //cardErro.style.display = "block"
      alert("Por favor, preencha todos os campos!")


      return false;
    } else if (alt_numeroSerial.value.length < 4) {
      alert("numeroSerial invalido!")
    } else if (alt_cpu.value == sessionStorage.CPU_MAQUINA && alt_ram.value == sessionStorage.RAM_MAQUINA
      && alt_disco.value == sessionStorage.DISCO_MAQUINA && alt_numeroSerial.value == sessionStorage.NUMEROSERIAL_MAQUINA) {
      alert("Nenhuma alteração feita!")
    }
    else {
      // Enviando o valor da nova input
      fetch("/maquina/alterar", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js

          cpunovoServer: cpuNovo,
          ramnovoServer: ramNovo,
          disconovoServer: discoNovo,
          numeroSerialnovoServer: numeroSerialNovo,
          numeroSerialVelhoServer: numeroSerialVelho
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);
        if (resposta.ok) {
          menssagem.style.display = "block";
          menssagem.innerHTML = "Alteração realizada com sucesso!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")
          alt_cpu.value = "";
          alt_ram.value = "";
          alt_disco.value = "";
          alt_numeroSerial.value = "";
          setTimeout(() => {
            window.location = "maquina.html";
          }, "2000")

        } else {
          throw ("Houve um erro ao tentar realizar o cadastro!");
          menssagem.style.display = "block";
          menssagem.innerHTML = "Houve um erro ao realizar o cadastro!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")

        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

      return false;
    }

  }

  listagemEmpresas()

  function listagemEmpresas() {

    fetch("/maquina/listar", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          localStorage.NUMEROSERIAL_LISTA = json.numeroSerial;
          console.log(json.length);

          for (i = 0; i < json.length; i++) {
            var registro = json[i];
            maquinas_lista.innerHTML += `<li><a  href="">${registro.numeroSerial}</a></li>`;
          }

          if (sessionStorage.NUMEROSERIAL_LISTA != null && sessionStorage.NUMEROSERIAL_LISTA != undefined) {
            // alert("Empresa encontrada!")
          } else {
            //   alert("empresa null ou undefined")
          }
        });

      } else {
        console.log("Houve um erro ao tentar encontrar as maquinas!");
        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function aparecerDelete() {

    var numeroSerial = Delet_numeroSerial.value;

    if (numeroSerial == "") {

      alert(`Preencha o campo cnpj!`)

      return false;
    }

    console.log("FORM numeroSerial: ", numeroSerial);

    fetch("/maquina/pegarMaquina", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        numeroSerialAltServer: numeroSerial,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          deletarMaq2.style.display = "block";
          buscarDelete.style.display = "none";

          sessionStorage.ID_MAQUINADEL = json.id;
          sessionStorage.CPU_MAQUINADEL = json.fkCpu;
          sessionStorage.RAM_MAQUINADEL = json.fkRam;
          sessionStorage.DISCO_MAQUINADEL = json.fkDisco;
          sessionStorage.NUMEROSERIAL_MAQUINADEL = json.numeroSerial;

          del_cpu.innerHTML = sessionStorage.CPU_MAQUINADEL;
          del_ram.innerHTML = sessionStorage.RAM_MAQUINADEL;
          del_disco.innerHTML = sessionStorage.DISCO_MAQUINADEL;
          del_numeroSerial.innerHTML = sessionStorage.NUMEROSERIAL_MAQUINADEL;


          if (sessionStorage.NUMEROSERIAL_MAQUINADEL != null && sessionStorage.NUMEROSERIAL_MAQUINADEL != undefined) {
            console.log("validação ok")
          }

        });

      } else {
        alert("Maquina não encontrada!")

        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          //    finalizarAguardar(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
      alert("Empresa não encontrada")
    })

    return false;
  }


  function deletar() {
    deletarMaq2.style.display = "block";
    buscarDelete.style.display = "none";

    var id = sessionStorage.ID_MAQUINADEL;

    if (id == "") {

      return false;
    }


    console.log("FORM id: ", id);

    fetch("/maquina/deletar", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idServer: id,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO DELETAR!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          alert("Empresa deletada com sucesso!")
        });

      } else {
        alert("Ops! há um erro no sistema, já estamos tentando resolver.")

        console.log("Houve um erro ao tentar deletar!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function voltar() {
    deletarMaq2.style.display = "none";
    buscarDelete.style.display = "block";
  }

</script>