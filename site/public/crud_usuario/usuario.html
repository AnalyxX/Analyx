<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>usuario</title>
  <link rel="stylesheet" href="../assets/css/usuario/usuarioo.css" />
</head>

<body>
  <section>

    <div class="navBarLateral">]
     
      <div class="navegarLeteral">
        <li style="display:none;" id="empresa_lateral"><a href="../crud_empresa/empresa.html">EMPRESA</a></li>
        <li> <a href="../crud_maquina/maquina.html"> MÁQUINA</a></li>
        <li><a href="../crud_funcionario/funcionario.html">FUNCIONÁRIO</a></li>
        <li id="aqui"> USUÁRIO</a></li>
      </div>
      <div class="sair" onclick="sair()"><span>Voltar</span></div>
    </div>

    <div class="areaPrincipal">
      <header>
        <nav>
          <ul>
            <li id="cadUsu" style="display:none"><a onclick="cadastrarUSU()">Cadastrar usuário</a></li>
            <li id="aqui2"><a style="display:block">Cadastrar usuário</a></li>
            <li id="altUsu" style="display: block;"><a onclick="alterarUSU()"> Alterar usuário</a></li>
            <li id="aqui3" style="display: none;"><a>Alterar usuário</a></li>
            <li id="listUsu" style="display: block;"><a onclick="listarUSU()">Listar usuário</a></li>
            <li id="aqui4" style="display: none;"><a>Listar usuário</a></li>
            <li id="deletUsu" style="display: block;"><a onclick="deletarUSU()">Deletar usuário</a></li>
            <li id="aqui5" style="display: none;"><a>Deletar usuário</a></li>
          </ul>
        </nav>
      </header>

      <div class="areaTitulo">

        <div id="tituloCAD" class="titulo">
          <h1>Cadastro usuário</h1>
        </div>

        <div id="tituloALT" class="titulo" style="display: none;">
          <h1>Buscar usuário</h1>
        </div>
        <div id="tituloLIST" class="titulo" style="display: none;">           
          <h1>Listagem de usuário</h1>                                  
        </div>                                                                              
        <div id="tituloDELET" class="titulo" style="display: none;">                 
          <h1>Deletar usuário</h1>                                       
        </div>                                                         
        <div class="menssagem" id="menssagem">

        </div>

      </div>


      <div id="cadastroUsu" class="cadastro-usu" style="display:block;">
        <div class="input" id="ipt-1">
          Email
          <input type="email" name="nome" id="cad_email" />
        </div>
        <div class="input" id="ipt-3">
          Senha
          <input type="password" name="setor" id="cad_senha" />
        </div>
        <div class="input" id="ipt-4">
          Confirmar Senha
          <input type="password" name="maquina" id="cad_ConfirmarSenha" />
        </div>
        <!-- <div class="input" id="ipt-4">
          Tipo: (java ou web)
          <input type="text" name="maquina" id="cad_tipo" />
        </div> -->
        <div class="input" id="ipt-4">
          Funcionário
          <input type="text" name="maquina" id="cad_funcionario" />
        </div>
        <button id="btn_entrar" onclick="cadastrar2()">Cadastrar</button>
      </div>


      <div id="alterarUsu" class="alterar-usu" style="display:none;">
        <div class="input2" id="ipt-1">
          Email:
          <input type="text" name="nome" id="Alt_email" />
          <button id="btn_entrar" onclick="aparecerBuscados()">Buscar</button>
        </div>
      </div>


      <div id="alterarUsu2" class="alterar-Usu2" style="display:none;">
        <div class="input3" id="ipt-1">
          Email
          <input type="text" name="nome" placeholder="Altere o email" id="alt_email" />
        </div>
        <div class="input3" id="ipt-2">
          Senha
          <input type="text" name="matricula" placeholder="Altere a Razão Social" id="alt_senha" />
        </div>
        <div class="input3" id="ipt-3">
          Tipo
          <input type="text" name="setor" placeholder="Altere o Responsável" id="alt_tipo" />
        </div>
        <div class="input3" id="ipt-4">
          Funcionario
          <input type="text" name="maquina" placeholder="Altere o Email" id="alt_funcionario" />
        </div>
        <button id="btn_entrar" onclick="alterar()">Alterar</button>
      </div>


      <div class="listar" id="listar" style="display: none;">
        <div class="listar2" id="listar2">

          <div id="listarUsu" class="listar-usu">
            <div class="input" id="ipt-1">
              Foram encontradas:
            </div>
            <div id="usuario_lista">
            </div>
          </div>

          <div id="listarUsu2" class="listar-usu2">
            <div class="input" id="ipt-1">
             <div class="tittle">email</div> 
              <input type="text" name="nome" id="list_email" />
            </div>
            <div class="input" id="ipt-2">
              <div class="tittle">Senha</div>
              <input type="text" name="matricula" id="list_senha" />
            </div>
            <div class="input" id="ipt-3">
              <div class="tittle">Tipo</div>
              <input type="text" name="setor" id="list_tipo" />
            </div>
            <div class="input" id="ipt-4">
              <div class="tittle">Funcionario</div>
              <input type="text" name="maquina" id="list_funcionario" />
            </div>
          </div>

        </div>
      </div>


      <div id="deletarUsu" class="deletar-usu" style="display:none;">
        <div id="buscarDelete" style="display:block;">
          <div class="input" id="ipt-1">
            Email
            <input type="text" name="nome" id="Delet_email" />
          </div>
          <button id="btn_entrar" onclick="aparecerDelete()">Procurar</button>
        </div>

        <div id="deletarUsu2" class="deletarUsu2" style="display:none;">
          <h3>Tem certeza que deseja excluir essa usuario ?</h3>
          <li>EMAIL:<span id="del_email"></span></li>
          <li>Senha:<span id="del_senha"></span></li>
          <!-- <li>Tipo:<span id="del_tipo"></span></li> -->
          <li>Funcionario:<span id="del_funcionario"></span></li>
          <div class="SimNao">
            <li onclick="deletar()">Sim</li>
            <li onclick="voltar()">Não</li>
          </div>
        </div>
      </div>
    </div>



  </section>
</body>

</html>
<script>
  var EmailUsuario = "";
  var NomeDousuario = "";

  EmailUsuario = sessionStorage.EMAIL_USUARIO;
                                                                        
  NomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;

  if (EmailUsuario != undefined && EmailUsuario.includes("analyx@")) {
    empresa_lateral.style.display = "block";
  }

  function sair() {
    window.location = "../dashboard-init.html";
    sessionStorage.clear();

  }

  //  console.log(EmailUsuario);
  //  if (EmailUsuario && EmailUsuario.includes("analyx@")) {
  //   listUSU.style.display = "block";
  //   deletUSU.style.display = "block";
  //  }

  function teste() {
    menssagem.style.display = "block";
    menssagem.innerHTML = "Cadastrado com sucesso!";
    setTimeout(() => {
      menssagem.style.display = "none";
    }, "4000")
  }


  function cadastrarUSU() {
    //header
    aqui3.style.display = "none";
    aqui4.style.display = "none";
    aqui5.style.display = "none";
    cadUsu.style.display = "none";

    altUsu.style.display = "block";
    listUsu.style.display = "block";
    deletUsu.style.display = "block";

    aqui2.style.display = "block";

    //social
    alterarUsu.style.display = "none";
    listarUsu.style.display = "none";
    deletarUsu.style.display = "none";
    alterarUsu2.style.display = "none";
    listar.style.display = "none";

    cadastroUsu.style.display = "block";

    //titulo
    tituloCAD.style.display = "block";
    tituloALT.style.display = "none";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "none";

  }
  function alterarUSU() {
    //header
    aqui2.style.display = "none";
    aqui4.style.display = "none";
    aqui5.style.display = "none";
    altUsu.style.display = "none";

    deletUsu.style.display = "block";
    listUsu.style.display = "block";
    cadUsu.style.display = "block";

    aqui3.style.display = "block";

    //social
    cadastroUsu.style.display = "none";
    listarUsu.style.display = "none";
    deletarUsu.style.display = "none";
    alterarUsu2.style.display = "none";
    listar.style.display = "none";


    alterarUsu.style.display = "block";

    //titulo
    tituloCAD.style.display = "none";
    tituloALT.style.display = "block";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "none";
  }

  function listarUSU() {
    //header
    aqui2.style.display = "none";
    aqui3.style.display = "none";
    aqui5.style.display = "none";
    listUsu.style.display = "none";

    cadUsu.style.display = "block";
    altUsu.style.display = "block";
    deletUsu.style.display = "block";

    aqui4.style.display = "block";


    //social
    cadastroUsu.style.display = "none";
    alterarUsu.style.display = "none";
    deletarUsu.style.display = "none";
    alterarUsu2.style.display = "none";


    listarUsu.style.display = "block";
    listar.style.display = "block";


    //titulo
    tituloCAD.style.display = "none";
    tituloALT.style.display = "none";
    tituloLIST.style.display = "block";
    tituloDELET.style.display = "none";
  }

  function deletarUSU() {
    //header
    aqui2.style.display = "none";
    aqui3.style.display = "none";
    aqui4.style.display = "none";
    deletUsu.style.display = "none";

    cadUsu.style.display = "block";
    altUsu.style.display = "block";
    listUsu.style.display = "block";

    aqui5.style.display = "block";

    //social
    cadastroUsu.style.display = "none";
    alterarUsu.style.display = "none";
    listarUsu.style.display = "none";
    alterarUsu2.style.display = "none";
    listar.style.display = "none";


    deletarUsu.style.display = "block";


    //titulo
    tituloCAD.style.display = "none";
    tituloALT.style.display = "none";
    tituloLIST.style.display = "none";
    tituloDELET.style.display = "block";

  }
  var ax_erro = false;
  function cadastrar2() {
    var email = cad_email.value;

    fetch("/usuarios/autenticarUSU", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        emailServer: email,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO autenticar usu()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          if (json === false) {
            alert("Já existe um usuario com o mesmo email!");
            ax_erro = true;
            return;
          } else {
            ax_erro = false;
            cadastrar();
          }


        });

      } else {

        console.log("Houve um erro ao tentar realizar o cadastro!");
        ax_erro = true;
        alert("Essa usuario já está cadastrada!")
        return;

        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
      ax_erro = true;

    })
    ax_erro = true;
  }

  function cadastrar() {
    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var email = cad_email.value;
    var senha = cad_senha.value;
    var confirmarSenha = cad_ConfirmarSenha.value;
    var tipo = 1;
    var funcionario = cad_funcionario.value;
    // var ax_erro = false


    if (email == "" || senha == "" || confirmarSenha == "" || funcionario == "") {
      //cardErro.style.display = "block"
      alert("Por favor, preencha todos os campos!")
      return false;

    } else if (cad_email.value.length < 10) {
      alert("email invalido! muito curto")
      return false;
    } else if (email.indexOf('@') == -1) {
      alert("Insira um email com @ ")
      return false;
    } else if (senha.length <= 5 && senha.length >= 25) {
      alert("senha precisa ter pelo menos 6 characters e menos de 25!")
      return false;
    } else if (confirmarSenha.length <= 5 && confirmarSenha.length > 25) {
      alert("senha precisa ter pelo menos 6 characters e menos de 25!")
      return false;
    } else if (email.length < 6) {
      alert("Email muito curto!")
      return false;
    } else if (senha != confirmarSenha) {
      alert("As senhas precisam ser iguais!");
      return false;
    } else if (funcionario >= 1000000) {
      alert("funcionario invalido!");
      return false;
    }
    if (ax_erro == false) {



      fetch("/usuarios/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          emailServer: email,
          senhaServer: senha,
          tipoServer: tipo,
          funcionarioServer: funcionario
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);


        if (resposta.ok) {

          alert("Cadastro realizado com sucesso!");
          setTimeout(() => {
            window.location = "usuario.html";
          }, "2000")


        } else {
          throw ("Houve um erro ao tentar realizar o cadastro!");
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        // finalizarAguardar();
      });
      return false;
    }
  }

  function aparecerBuscados() {


    var email = Alt_email.value;

    console.log(email);

    if (email == "") {

      alert(`Preencha o campo email!`)

      return false;
    }

    console.log("FORM email: ", email);

    fetch("/usuarios/pegarUsuario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        emailAltServer: email,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        if (resposta.status == 204) {
          alert("Nenhuma empresa encontrada!")
        } else {
          resposta.json().then(json => {
            console.log(json);
            console.log(JSON.stringify(json));


            sessionStorage.ID_USUARIOALT = json.id;
            sessionStorage.EMAIL_USUARIOALT = json.email;
            sessionStorage.SENHA_USUARIOALT = json.senha;
            //           sessionStorage.TIPO_USUARIOALT = json.fkTipoUsuario;
            sessionStorage.FUNCIONARIO_USUARIOALT = json.fkFuncionario;

            alt_email.value = sessionStorage.EMAIL_USUARIOALT;
            alt_senha.value = sessionStorage.SENHA_USUARIOALT;
            //           alt_tipo.value = sessionStorage.TIPO_USUARIOALT;
            alt_funcionario.value = sessionStorage.FUNCIONARIO_USUARIOALT;

            if (sessionStorage.EMAIL_USUARIOALT != null && sessionStorage.EMAIL_USUARIOALT != undefined) {
              alert("usuario encontrada!")
            }


            alterarUsu2.style.display = "block";
            alterarUsu.style.height = "15%";
            console.log(sessionStorage.EMAIL_USUARIOALT);

          });


        }
      } else {
        alert("Email ou senha invalidos!")

        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          //    finalizarAguardar(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }


  function alterar() {
    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var emailNovo = alt_email.value;
    var senhaNovo = alt_senha.value;
    var tipoNovo = 1;
    var funcionarioNovo = alt_funcionario.value;
    var id = sessionStorage.ID_USUARIOALT;
    console.log(id);
    var ax_erro = false;


    if (alt_email.value == "" || alt_senha.value == "" || alt_funcionario.value == "") {
      //cardErro.style.display = "block"
      alert("Por favor, preencha todos os campos!")
      return false;
    } else if (alt_email.value.length < 10) {
      alert("email invalido!")
    } else if (!emailNovo || emailNovo.indexOf('@') == -1 || emailNovo.length <= 10) {
      alert("Insira um email válido com @ ou mais longo!");
    } else if (senhaNovo.length <= 2 || senhaNovo.length >= 25) {
      alert("Razao social não pode ser muito curta ou muito longa")
    } else if (emailNovo.length < 6) {
      alert("Email muito curto!")
    } else if (funcionarioNovo.length >= 10) {
      alert("Telefone invalido!")
    } else if (alt_email.value == sessionStorage.EMAIL_USUARIOALT && alt_senha.value == sessionStorage.SENHA_USUARIOALT
      && alt_funcionario.value == sessionStorage.FUNCIONARIO_USUARIOALT) {
      alert("Nenhuma alteração feita!")
    }
    else {
      // Enviando o valor da nova input
      fetch("/usuarios/alterar", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js
          emailnovoServer: emailNovo,
          senhanovoServer: senhaNovo,
          //    tiponovoServer: tipoNovo,
          funcionarionovoServer: funcionarioNovo,
          idServer: id,
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);
        if (resposta.ok) {

          menssagem.style.display = "block";
          menssagem.innerHTML = "Alteração realizada com sucesso!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")

          alt_email.value = "";
          alt_senha.value = "";
          //     alt_tipo.value = "";
          alt_funcionario.value = "";
          setTimeout(() => {
            window.location = "usuario.html";
          }, "2000")

        } else {
          throw ("Houve um erro ao tentar realizar a alteração!");
          menssagem.style.display = "block";
          menssagem.innerHTML = "Houve um erro ao realizar a alteração!";
          setTimeout(() => {
            menssagem.style.display = "none";
          }, "4000")

        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

      return false;
    }

  }

  var informacaoList = -1;
  function listUsuarios(i) {
    informacaoList = i;
    listagemUsuarios();

  }
  var listarUmaVez = false;


  listagemUsuarios()

  function listagemUsuarios() {

    fetch("/usuarios/listar", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.EMAIL_USUARIOLIST = json.email;
          console.log(json.length);

          if (listarUmaVez == false) {
            for (i = 0; i < json.length; i++) {
              var registro = json[i];
              usuario_lista.innerHTML += `<li onclick="listUsuarios(${i})">${registro.email}</li>`;
              listarUmaVez = true;
            }
          }


          for (i = 0; i < json.length; i++) {
            var registro = json[i];
            if (informacaoList >= 0) {
              if (i == informacaoList) {
                if (registro.tipo == 1) {
                  registro.tipo = 'web';
                } else if (registro.tipo == 2) {
                  registro.tipo = 'java';
                }

                list_email.value = `${registro.email}`;
                list_senha.value = `${registro.senha}`;
                list_tipo.value = `${registro.fkTipoUsuario}`;
                list_funcionario.value = `${registro.fkFuncionario}`;
              }
            }
          }

          if (sessionStorage.EMAIL_USUARIOLIST != null && sessionStorage.EMAIL_USUARIOLIST != undefined) {
            // alert("USUresa encontrada!")
          } else {
            //   alert("USUresa null ou undefined")
          }
        });

      } else {
        console.log("Houve um erro ao tentar encontrar usuario!");
        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }



  function aparecerDelete() {

    var email = Delet_email.value;

    console.log(email);

    if (email.value == "") {

      alert(`Preencha o campo email!`)

      return false;
    }

    console.log("FORM email: ", email);

    fetch("/usuarios/pegarUsuario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        emailAltServer: email,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO aparecerBuscados()!")

      if (resposta.ok) {
        console.log(resposta);

        if (resposta.status == 204) {
          alert("Nenhuma empresa encontrada!")
        } else {
          resposta.json().then(json => {
            console.log(json);
            console.log(JSON.stringify(json));
            deletarUsu2.style.display = "block";
            buscarDelete.style.display = "none";

            sessionStorage.ID_USUARIODEL = json.id;
            sessionStorage.EMAIL_USUARIODEL = json.email;
            sessionStorage.SENHA_USUARIODEL = json.senha;
            //     sessionStorage.TIPO_USUARIODEL = json.fkTipoUsuario;
            sessionStorage.FUNCIONARIO_USUARIODEL = json.fkFuncionario;

            del_email.innerHTML = sessionStorage.EMAIL_USUARIODEL;
            del_senha.innerHTML = sessionStorage.SENHA_USUARIODEL;
            //     del_tipo.innerHTML = sessionStorage.TIPO_USUARIODEL;
            del_funcionario.innerHTML = sessionStorage.FUNCIONARIO_USUARIODEL;


            if (sessionStorage.EMAIL_USUARIODEL != null && sessionStorage.EMAIL_USUARIODEL != undefined) {
              alert("usuario encontrada!")
            }

          });
        }
      } else {
        alert("Email ou senha invalidos!")

        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          //    finalizarAguardar(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
      alert("usuario não encontrada")
    })

    return false;
  }


  function deletar() {
    deletarUsu2.style.display = "block";
    buscarDelete.style.display = "none";

    var id = sessionStorage.ID_USUARIODEL;

    if (id == "") {

      return false;
    }


    console.log("FORM id: ", id);

    fetch("/usuarios/deletar", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idServer: id,
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO DELETAR!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          alert("usuario deletada com sucesso!")
          deletarUsu2.style.display = "none";
          buscarDelete.style.display = "block";
        });

      } else {
        alert("Ops! há um erro no sistema, já estamos tentando resolver.")

        console.log("Houve um erro ao tentar deletar!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function voltar() {
    deletarUsu2.style.display = "none";
    buscarDelete.style.display = "block";
  }
</script>