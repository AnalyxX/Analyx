<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyx | Dashboard</title>
    <link rel="stylesheet" href="../assets/css/dashboard/dashboard-init.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body onload="instance()">

    <div id="right_menu" class="right-menu">
        <div class="icons">
            <i id="exit_menu" onclick="hideMenu()" class="fa-solid fa-xmark" title="Fechar menu lateral"></i>
            <i id="settings_menu" class="fa-solid fa-gear" title="Abrir configurações"></i>
        </div>

        <div class="profile">

            <img class="profile-img" src="../assets/images/fotor_2023-4-8_2_11_54.png" alt="">

            <div class="text">
                <h1> Olá, <b id="b_usuario"></b> </h1>

            </div>
        </div>

        <div class="exit">
            <button> Sair </button>
        </div>

    </div>



    <div class="content">
        <div class="header">
            <div class="container">
                <div class="navbar">

                    <div class="return" onclick="back()" title="Voltar ao menu principal">


                    </div>

                    <div class="logo-align">
                        <img class="logo" src="../assets/images/logo-analyx.svg" alt="">
                    </div>

                    <div id="menu" class="menu">
                        <i id="bars" onclick="showMenu()" class="fa-solid fa-bars" title="Abrir menu lateral"></i>
                    </div>

                </div>
            </div>
        </div>

        <div class="analytics">
            <div class="container">
                <div class="card-align">
                    <div class="card">
                        <div class="container">
                            <div class="header-card">
                                <h1> Sei lá </h1>
                            </div>

                            <div class="grafics">
                                <div class="machine-grafic-width">
                                    <canvas id="week_grafic"></canvas>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="card">
                        <div class="container">
                            <div class="header-card">
                                <h1> Tanto faz </h1>
                            </div>

                            <div class="grafics">
                                <div class="machine-grafic-width">
                                    <canvas id="secondWeek_grafic"></canvas>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="container">
                    <div class="list-func">
                        <h1>Maquinas cadastradas</h1>
                        <div class="func-title">
                            <h1>Total de máquinas: <b id="qtd_maquina"></b> </h1>
                            <div>
                                <p> Estáveis </p>
                                <i id="cpu_check" style="color: green;" class="fa-solid fa-circle-check"> <b
                                        style="color: white;">13</b></i>
                            </div>

                            <div>
                                <p> Alertas </p>
                                <i id="cpu_alert" style="color: yellow;" class="fa-solid fa-circle-exclamation"><b
                                        style="color: white; margin-left: 10%;">13</b></i>
                            </div>

                            <div>
                                <p> Críticas </p>
                                <i id="cpu_alert" style="color: red;" class="fa-solid fa-circle-exclamation"><b
                                        style="color: white; margin-left: 10%;">13</b></i>
                            </div>
                        </div>

                        <div class="func-align">
                            <div class="values-title">
                                <h1> Matrícula </h1>
                                <h1> Nome </h1>
                                <h1> Alerta </h1>
                            </div>

                            <div class="scroll" id="scroll_text">
                                <div class="line-values" onclick="toSecondDash()">
                                    <p> 0012232179</p>
                                    <p> Roberto Faria </p>
                                    <p> <i id="cpu_alert" style="color: red;"
                                            class="fa-solid fa-circle-exclamation"></i>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</body>
<script src="../js/dash.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

    function back() {
        window.location = "dashboardInit.html"
    }

    function toSecondDash() {
        window.location = "dashboard2.html"
    }

    function instance() {
        getWeek(2)
        getSecondWeek(2)
        getCountMachines()
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let chartWeek;
    let chartSecondWeek;

    function getWeek(idFunc) {
        fetch(`/dashboard/getUseCpuByFuncId/${idFunc}`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    const points = [];
                    const labels = [];

                    // TROUXE OS 5 DADOS OBTIDOS NOS ULTIMOS MINUTOS
                    resposta.forEach((element, index) => {
                        points.push(element.uso)
                        labels.push(element.hora)
                    });

                    loadWeek(points, labels)

                    setTimeout(() => {
                        getWeek(idFunc)
                    }, 10000)

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function getSecondWeek(idFunc) {
        fetch(`/dashboard/getUseCpuByFuncId/${idFunc}`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    const points = [];
                    const labels = [];

                    // TROUXE OS 5 DADOS OBTIDOS NOS ULTIMOS MINUTOS
                    resposta.forEach((element, index) => {
                        points.push(element.uso)
                        labels.push(element.hora)
                    });

                    loadSecondWeek(points, labels)

                    setTimeout(() => {
                        getSecondWeek(idFunc)
                    }, 10000)

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function getCountMachines() {
        fetch(`/dashboard/getCountMachines`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    let quantityMachine = resposta[0].total_maquina

                    qtd_maquina.innerHTML = `${quantityMachine}`

                    setTimeout(() => {
                        getCountMachines()
                    }, 10000)

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function loadWeek(points, labels) {
        const ctx1 = document.getElementById('week_grafic');

        if (chartWeek) chartWeek.destroy();

        chartWeek = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Componentes em alerta na última semana',
                    data: points,
                    borderWidth: 1,

                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: {
                            color: 'white'
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            color: '#ffffff',
                            stepSize: 25
                        },
                        grid: {
                            color: (context) => {
                                if (context.tick.value == 75) {
                                    return 'rgb(255, 0, 0)'
                                } else {
                                    return 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    },
                    x: {
                        ticks: {
                            color: '#ffffff'
                        }
                    }
                },
                legend: {
                    labels: {
                        fontColor: 'rgb(255, 99, 132)'
                    }
                },
                datalabels: {
                    color: 'white'
                }
            }
        });
    }

    function loadSecondWeek(points, labels) {
        const ctx1 = document.getElementById('secondWeek_grafic');

        if (chartSecondWeek) chartSecondWeek.destroy();

        chartSecondWeek = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Uso de CPU por minuto',
                    data: points,
                    borderWidth: 1,

                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: {
                            color: 'white'
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            color: '#ffffff',
                            stepSize: 25
                        },
                        grid: {
                            color: (context) => {
                                if (context.tick.value == 75) {
                                    return 'rgb(255, 0, 0)'
                                } else {
                                    return 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    },
                    x: {
                        ticks: {
                            color: '#ffffff'
                        }
                    }
                },
                legend: {
                    labels: {
                        fontColor: 'rgb(255, 99, 132)'
                    }
                },
                datalabels: {
                    color: 'white'
                }
            }
        });
    }


</script>